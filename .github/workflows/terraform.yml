# =============================================================================
# Terraform Workflow
# =============================================================================
# Validates Terraform configuration on push and pull requests.
# =============================================================================

name: Terraform

on:
  push:
    branches: [main]
    paths:
      - 'infrastructure/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches: [main]
    paths:
      - 'infrastructure/**'
      - '.github/workflows/terraform.yml'

# TODO: Add workflow_dispatch for manual triggering
# workflow_dispatch:
#   inputs:
#     environment:
#       description: 'Environment to deploy to'
#       required: true
#       default: 'dev'
#       type: choice
#       options:
#         - dev
#         - staging
#         - prod

env:
  TF_WORKING_DIR: infrastructure
  # TODO: Set Terraform version from .terraform-version file
  TF_VERSION: '1.9.0'

# TODO: Add concurrency control for deployments
# concurrency:
#   group: terraform-${{ github.ref }}
#   cancel-in-progress: false

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

  # ---------------------------------------------------------------------------
  # TODO: Enable Plan Job (requires AWS credentials)
  # ---------------------------------------------------------------------------
  # Uncomment this job when ready to run terraform plan in CI.
  # You'll need to configure AWS credentials as GitHub secrets:
  # - AWS_ACCESS_KEY_ID
  # - AWS_SECRET_ACCESS_KEY
  # Or use OIDC for keyless authentication (recommended).
  # ---------------------------------------------------------------------------
  #
  # plan:
  #   name: Plan
  #   runs-on: ubuntu-latest
  #   needs: validate
  #   if: github.event_name == 'pull_request'
  #
  #   defaults:
  #     run:
  #       working-directory: ${{ env.TF_WORKING_DIR }}
  #
  #   # TODO: Configure AWS credentials
  #   # Option 1: Using access keys (not recommended for production)
  #   # env:
  #   #   AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #   #   AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #
  #   # Option 2: OIDC (recommended)
  #   # permissions:
  #   #   id-token: write
  #   #   contents: read
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Terraform
  #       uses: hashicorp/setup-terraform@v3
  #       with:
  #         terraform_version: ${{ env.TF_VERSION }}
  #
  #     # TODO: Configure AWS credentials using OIDC
  #     # - name: Configure AWS credentials
  #     #   uses: aws-actions/configure-aws-credentials@v4
  #     #   with:
  #     #     role-to-assume: arn:aws:iam::ACCOUNT_ID:role/GitHubActionsRole
  #     #     aws-region: us-east-1
  #
  #     - name: Terraform Init
  #       run: terraform init
  #
  #     - name: Terraform Plan
  #       run: terraform plan -no-color -out=tfplan
  #
  #     # TODO: Post plan output to PR
  #     # - name: Comment Plan on PR
  #     #   uses: actions/github-script@v7
  #     #   with:
  #     #     script: |
  #     #       // Add plan output as PR comment

  # ---------------------------------------------------------------------------
  # TODO: Enable Apply Job for Deployments
  # ---------------------------------------------------------------------------
  # Uncomment when ready for automated deployments.
  # Consider adding:
  # - Environment protection rules
  # - Manual approval for production
  # - Deployment notifications (Slack, etc.)
  # ---------------------------------------------------------------------------
  #
  # apply:
  #   name: Apply
  #   runs-on: ubuntu-latest
  #   needs: plan
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   environment: production  # Requires approval if configured
  #
  #   defaults:
  #     run:
  #       working-directory: ${{ env.TF_WORKING_DIR }}
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Terraform
  #       uses: hashicorp/setup-terraform@v3
  #       with:
  #         terraform_version: ${{ env.TF_VERSION }}
  #
  #     # TODO: Configure AWS credentials (same as plan job)
  #
  #     - name: Terraform Init
  #       run: terraform init
  #
  #     - name: Terraform Apply
  #       run: terraform apply -auto-approve
